name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for the release (e.g. 1.0.0 or 1.0.0-beta.1)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate version format
      run: |
        # Validate version format: X.Y.Z or X.Y.Z-prerelease.N
        if [[ ! "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
          echo "::error::Version must be in format X.Y.Z or X.Y.Z-suffix.N (e.g., 1.0.0 or 1.0.0-beta.1)"
          exit 1
        fi
    
    - name: Configure Git user
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Get previous tag
      id: prev_tag
      run: |
        git fetch --tags
        PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${{ github.event.inputs.version }}$" | head -n1)
        echo "Previous tag: $PREV_TAG"
        echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

    - name: Create tag
      run: |
        git tag ${{ github.event.inputs.version }}
        git push origin ${{ github.event.inputs.version }}

    - name: Display release information
      run: |
        echo "Starting release process for version ${{ github.event.inputs.version }}"
        echo "This workflow will:"
        echo "1. Download pre-built Android libraries"
        echo "2. Build the Android AAR"
        echo "3. Create a GitHub release with artifacts"

    - name: Set up JDK 17
      id: setup-java
      uses: actions/setup-java@v3
      with:
        java-version: "17"
        distribution: "temurin"

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Set environment variables
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

    - name: Build Android AAR
      env:
        JAVA_HOME: ${{ steps.setup-java.outputs.path }}
      run: |
        make library

    - name: List AAR artifacts
      run: |
        echo "Built AAR files:"
        find library/build/outputs/aar -name "*.aar" -type f

    - name: Publish to GitHub Packages
      env:
        JAVA_HOME: ${{ steps.setup-java.outputs.path }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI_COMMIT_TAG: ${{ github.event.inputs.version }}
      run: |
        make publish

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: C2PA Android ${{ github.event.inputs.version }}
        files: |
          library/build/outputs/aar/*.aar
        body: |
          # C2PA Android Release ${{ github.event.inputs.version }}

          ## Installation

          The library is available from **JitPack** and **GitHub Packages**.

          ### JitPack (Recommended)

          ```gradle
          // In settings.gradle
          dependencyResolutionManagement {
              repositories {
                  maven { url 'https://jitpack.io' }
              }
          }

          // In build.gradle
          dependencies {
              implementation 'com.github.contentauth:c2pa-android:${{ github.event.inputs.version }}'
          }
          ```

          ### GitHub Packages

          Requires authentication with a GitHub token:

          ```gradle
          // In build.gradle
          dependencies {
              implementation 'org.contentauth:c2pa:${{ github.event.inputs.version }}'
          }
          ```

          ### Manual AAR

          Download the AAR from this release and add to your project:

          ```gradle
          dependencies {
              implementation files('libs/c2pa-release.aar')
          }
          ```

          ## Documentation

          See the [README.md](https://github.com/${{ github.repository }}) for detailed integration instructions and API documentation.

          ## What's Changed

          See the [commit history](https://github.com/${{ github.repository }}/compare/${{ steps.prev_tag.outputs.tag }}...${{ github.event.inputs.version }}) for a full list of changes.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
